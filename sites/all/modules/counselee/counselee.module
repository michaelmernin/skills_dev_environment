<?php

/**
 * @file
 * 
 * This is the counselee module
 * 
 * 
 */
function counselee_menu() {
  $items['mydashboard'] = array(
    'title' => 'My Dashboard',
    'page callback' => 'dashboard_display',
    'page arguments' => array(),
    'access arguments' => array('access to my dashboard'),
    'file' => 'files/dashboard.pages.inc',
  );
  return $items;
}

function counselee_permission() {
  return array(
    'access to my dashboard' => array(
      'title' => t('Access to my dashboard'),
    ),
//        'config reviews' => array(
//            'title' => t('Config reviews'),
//        ),
  );
}

function counselee_block_info() {
  $blocks['user_status'] = array(
    'info' => t('User Status View'),
    'cache' => DRUPAL_NO_CACHE, // no cache
  );
  $blocks['my_work_stage'] = array(
    'info' => t('My Working Stage'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

function counselee_block_view($delta = '') {
//The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'user_status':
      appendCSSJS();
//            $block['subject'] = render_subject_use_image('Configure Timeslot');
      $status_info = select_reviewer_status_from_BD();
      $block['content'] = theme('user_status_view', array('status_info' => $status_info));
      break;
    case 'my_work_stage':
      $counseleePeers = counselee_select_peers('counselee', get_current_user_name(), 0);
      $counselorPeers = counselee_select_peers('counselor', get_current_user_name(), 0);
      $reviewList = counselee_do_peersreview(get_current_user_name());
      $block['content'] = theme('my_working_list_view', array('counseleePeers' => $counseleePeers, 'counselorPeers' => $counselorPeers, 'reviewList' => $reviewList));
      break;
  }
  return $block;
}

function counselee_theme() {
  return array(
    'user_status_view' => array(
      'variables' => array('status_info' => NULL),
      'path' => drupal_get_path('module', 'counselee') . '/templates',
      'template' => 'user_status_view',),
    'my_working_list_view' => array(
      'variables' => array('counseleePeers' => NULL, 'counselorPeers' => NULL, 'reviewList' => NULL),
      'path' => drupal_get_path('module', 'counselee') . '/templates',
      'template' => 'my_working_list',),
  );
}

/**
 * select_reviewer_status_from_BD
 * @return type
 * @author Mars
 */
function select_reviewer_status_from_BD() {
  $status_info = array();
  $cur_user_name = get_current_user_name();
  if (module_exists('counsellor') && module_enable(array('counsellor'))) {
    $result = get_counselees_from_db();
    // counselee login
    $my_name = array($cur_user_name);
    $my_review_status = get_status_from_db($my_name);
//    dd('$my_review_status');
//    dd($my_review_status);
    if (count($result) != '0') {
      // counsellor login
      $counselee_name_array = generate_selectseed_participant_array($result);
      $counselee_status = get_status_from_db($counselee_name_array);
//      dd('$counselee_status');
//      dd($counselee_status);
      foreach ($counselee_status as $key => $status) {
        array_push($my_review_status, $status);
      }
    }
  }
  $status_info = $my_review_status;
//  dd('$status_info');
//  dd($status_info);
  return $status_info;
}

/**
 * This funciton is for counselee to select peers
 * 
 * 
 * @param string $user counselee name
 * @param int $reviewtype The review type
 * @return result The review to select peers  
 * @author Palmer
 */
function counselee_select_peers($userType, $userName, $reviewType) {

  if ($userType === 'counselee') {
    $selPeersStatus = array(0, 2);
    $counselee_query = db_select('prs_rel_review_employee', 'review');
    $counselee_query->join('prs_general', 'general', 'general.prid=review.prid');
    $counselee_query->addField('review', 'employeeName');
    $counselee_query->addField('review', 'rreid');
    $counselee_query->addField('general', 'type');
    $counselee_query->condition('review.employeeName', $userName);
    $counselee_query->condition('review.rstatus', 1);
    $counselee_query->condition('general.type', $reviewType);
    $counselee_query->condition('review.spstatus', $selPeersStatus, 'in');

    $dataset = $counselee_query->execute()->fetchAll();
  }
  else if ($userType === 'counselor') {
    $selPeersStatus = array(0, 1);
    $counselor_query = db_select('prs_rel_employee_counselor_gm', 'relation');
    $counselor_query->join('prs_rel_review_employee', 'review', 'relation.employeeName = review.employeeName');
    $counselor_query->join('prs_general', 'general', 'general.prid=review.prid');
    $counselor_query->addField('relation', 'employeeName');
    $counselor_query->addField('review', 'rreid');
    $counselor_query->addField('general', 'type');
    $counselor_query->condition('relation.counselorName', $userName);
    $counselor_query->condition('review.rstatus', 1);
    $counselor_query->condition('general.type', $reviewType);
    $counselor_query->condition('review.spstatus', $selPeersStatus, 'in');

    $dataset = $counselor_query->execute()->fetchAll();
  }
  
  $result = array();
  $index = 0;
  foreach ($dataset as $node) {
    $employeeName = $node->employeeName;
    $rreid = $node->rreid;
    $reviewtype = $node->type;
    $temp = array('employeeName' => $employeeName, 'rreid' => $rreid, 'reviewType' => $reviewtype);
    $result[$index++] = $temp;
  }
  return $result;
}

/**
 * get_status_from_db
 * 
 * @param type $employeeName
 * @return type
 * @author Mars
 */
function get_status_from_db($employeeName) {
//   $cur_user_name = get_current_user_name();
  $query = db_select('prs_rel_review_employee', 're');
  $query->join('prs_general', 'pg', 'pg.prid=re.prid');
  $query->fields('re', array('employeeName', 'rreid', 'rstatus'));
  $query->addField('pg', 'period_start');
  $query->addField('pg', 'period_end');
  $query->addField('pg', 'type');
  $query->addField('pg', 'description');
  $query->condition('re.employeeName', $employeeName, 'in');
  $query->orderBy('re.rstatus', 'ASC');
  $result = $query->execute()->fetchAll();
  return $result;
}

/**
 * This function is to show the user to do peers review
 * 
 * @param string $userName the current user login name
 * @return array Current user to do reviewList
 */
function counselee_do_peersreview($userName) {
  $peers_query = db_select('prs_rel_provider_employee', 'provider');
  $peers_query->join('prs_general', 'general', 'general.prid = provider.prid');
  $peers_query->addField('general', 'type');
  $peers_query->addField('provider', 'employeeName');
  $peers_query->addField('provider', 'rpeid');
  $peers_query->condition('provider.providerName', $userName);
  $dataset = $peers_query->execute()->fetchAll();

  $result = array();
  $index = 0;
  foreach ($dataset as $node) {
    $employeeName = $node->employeeName;
    $rpeid = $node->rpeid;
    $reviewtype = $node->type;
    $temp = array('employeeName' => $employeeName, 'rpeid' => $rpeid, 'reviewType' => $reviewtype);
    $result[$index++] = $temp;
  }
  return $result;
}

